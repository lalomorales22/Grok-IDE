<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>◤ GROK IDE ◥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }

        .navbar {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #0a0a0a;
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 2px;
        }

        .main-container {
            display: flex;
            flex: 1;
            background-color: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background-color: #111111;
            border-right: 2px solid #ffffff;
            display: flex;
            flex-direction: column;
            min-width: 200px;
            max-width: 500px;
        }

        .sidebar-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            border-bottom: 1px solid #ffffff;
            background-color: #1a1a1a;
            letter-spacing: 1px;
        }

        .sidebar-controls {
            padding: 0.75rem;
            border-bottom: 1px solid #ffffff;
            background-color: #111111;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-row {
            display: flex;
            gap: 0.5rem;
        }

        .button {
            padding: 0.5rem 1rem;
            background-color: #0a0a0a;
            border: 1px solid #ffffff;
            color: #ffffff;
            cursor: pointer;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            flex: 1;
        }

        .button:hover {
            background-color: #ffffff;
            color: #0a0a0a;
        }

        .button:disabled {
            background-color: #1a1a1a;
            color: #666666;
            cursor: not-allowed;
            border-color: #333333;
        }

        .button:disabled:hover {
            background-color: #1a1a1a;
            color: #666666;
        }

        .file-explorer {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            background-color: #111111;
        }

        .folder {
            margin-bottom: 0.25rem;
        }

        .folder-name {
            padding: 0.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .folder-name:hover {
            background-color: #1a1a1a;
            border-color: #ffffff;
        }

        .folder-icon {
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }

        .files {
            margin-left: 1.5rem;
        }

        .file {
            padding: 0.3rem;
            padding-left: 1.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .file:hover {
            background-color: #1a1a1a;
            border-color: #ffffff;
        }

        .file-icon {
            margin-right: 0.5rem;
            font-size: 0.8rem;
        }

        .editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #0a0a0a;
        }

        .tabs {
            display: flex;
            background-color: #111111;
            border-bottom: 1px solid #ffffff;
            overflow-x: auto;
            min-height: 40px;
        }

        .tab {
            padding: 0.6rem 1rem;
            background-color: #111111;
            border: none;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.8rem;
            border-right: 1px solid #333333;
            transition: all 0.2s ease;
        }

        .tab.active {
            background-color: #0a0a0a;
            border-bottom: 2px solid #ffffff;
        }

        .tab:hover {
            background-color: #1a1a1a;
        }

        .tab-close {
            margin-left: 0.5rem;
            padding: 0 0.3rem;
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .tab-close:hover {
            background-color: #ffffff;
            color: #0a0a0a;
        }

        .editor-content {
            flex: 1;
            padding: 0;
            background-color: #0a0a0a;
        }

        #editor {
            width: 100%;
            height: 100%;
            background-color: #0a0a0a;
            color: #ffffff;
            border: none;
            resize: none;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 1rem;
            outline: none;
        }

        .welcome-message {
            text-align: center;
            padding: 2rem;
            color: #40e0d0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ai-column {
            width: 350px;
            background-color: #111111;
            border-left: 2px solid #ffffff;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            overflow: hidden;
            min-width: 200px;
            max-width: 600px;
        }

        .ai-header {
            padding: 0.75rem 1rem;
            background-color: #1a1a1a;
            border-bottom: 1px solid #ffffff;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 1px;
        }

        .ai-mode-selector {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .mode-btn {
            padding: 0.3rem 0.6rem;
            background-color: #0a0a0a;
            border: 1px solid #ffffff;
            color: #ffffff;
            cursor: pointer;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.7rem;
            font-weight: bold;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }

        .mode-btn.active {
            background-color: #ffffff;
            color: #0a0a0a;
        }

        .mode-btn:hover {
            background-color: #ffffff;
            color: #0a0a0a;
        }

        .ai-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            background-color: #111111;
        }

        .ai-content::-webkit-scrollbar {
            width: 8px;
        }

        .ai-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .ai-content::-webkit-scrollbar-thumb {
            background-color: #ffffff;
            border-radius: 4px;
        }

        .ai-content::-webkit-scrollbar-thumb:hover {
            background-color: #cccccc;
        }

        .ai-input-area {
            padding: 0.75rem;
            background-color: #1a1a1a;
            border-top: 1px solid #ffffff;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ai-input-area textarea {
            width: 100%;
            background-color: #0a0a0a;
            color: #ffffff;
            border: 1px solid #ffffff;
            padding: 0.75rem;
            resize: none;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            min-height: 80px;
            outline: none;
        }

        .ai-input-area textarea::placeholder {
            color: #40e0d0;
        }

        .ai-message {
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            border: 1px solid #333333;
            background-color: #0a0a0a;
        }

        .ai-message pre {
            position: relative;
            background: #1a1a1a;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid #ffffff;
            overflow-x: auto;
        }

        .ai-message code {
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            color: #ffffff;
        }

        .code-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .code-action-btn {
            padding: 0.25rem 0.5rem;
            background: #0a0a0a;
            border: 1px solid #ffffff;
            color: #ffffff;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Consolas', 'Courier New', monospace;
            transition: all 0.2s ease;
        }

        .code-action-btn:hover {
            background: #ffffff;
            color: #0a0a0a;
        }

        .resize-handle {
            width: 4px;
            background-color: #ffffff;
            cursor: col-resize;
            transition: background-color 0.2s;
            opacity: 0.3;
        }

        .resize-handle:hover, .resize-handle.active {
            background-color: #ffffff;
            opacity: 1;
        }

        .context-menu {
            position: fixed;
            background: #1a1a1a;
            border: 2px solid #ffffff;
            padding: 4px 0;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .context-menu-item:hover {
            background: #ffffff;
            color: #0a0a0a;
        }

        .context-menu-separator {
            height: 1px;
            background: #ffffff;
            margin: 4px 0;
        }

        .new-item-input {
            position: relative;
            padding: 4px 8px;
            background: #0a0a0a;
            border: 2px solid #ffffff;
            margin: 0.25rem;
        }

        .new-item-input input {
            width: 100%;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 13px;
            outline: none;
            padding: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .new-item-input input::placeholder {
            color: #40e0d0;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #ffffff;
            margin: 0.5rem 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #333333;
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online {
            background-color: #00ff00;
            box-shadow: 0 0 4px #00ff00;
        }

        .status-offline {
            background-color: #ff0000;
            box-shadow: 0 0 4px #ff0000;
        }

        .status-processing {
            background-color: #ffff00;
            box-shadow: 0 0 4px #ffff00;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Footer Status Bar */
        .footer-status {
            height: 28px;
            background-color: #1a1a1a;
            border-top: 1px solid #ffffff;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            font-size: 0.75rem;
            color: #40e0d0;
            font-family: 'Consolas', 'Courier New', monospace;
            justify-content: space-between;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #00ff00;
        }

        .status-dot.offline {
            background-color: #ff0000;
        }

        .status-dot.processing {
            background-color: #ffff00;
            animation: pulse 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="navbar">
        ◤ GROK IDE ◥
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                EXPLORER
                <span id="refreshBtn" onclick="refreshFileExplorer()" style="cursor: pointer; opacity: 0.7;" title="Refresh">🔄</span>
            </div>
            
            <div class="sidebar-controls">
                <div class="control-row">
                    <button id="openFolderBtn" class="button" onclick="openFolder()">OPEN FOLDER</button>
                    <button id="saveBtn" class="button" onclick="saveCurrentFile()" disabled>SAVE</button>
                </div>
                <div class="control-row">
                    <button id="saveAllBtn" class="button" onclick="saveAllFiles()" disabled>SAVE ALL</button>
                    <button id="newFileBtn" class="button" onclick="createNewFileInRoot()" disabled>NEW FILE</button>
                </div>
            </div>
            
            <div id="fileExplorer" class="file-explorer">
                <div class="welcome-message">
                    Click "OPEN FOLDER" to begin operations
                </div>
            </div>
        </div>
        
        <div class="resize-handle" id="leftResizeHandle"></div>

        <div class="editor">
            <div id="tabs" class="tabs"></div>
            <div class="editor-content">
                <textarea id="editor" placeholder="Select a file to begin editing..." disabled></textarea>
            </div>
        </div>

        <div class="resize-handle" id="rightResizeHandle"></div>
        
        <div class="ai-column">
            <div class="ai-header">
                GROK ASSISTANT
                <button id="clearAIBtn" onclick="clearAIChat()" class="button" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">CLEAR</button>
            </div>
            
            <div class="ai-mode-selector" style="padding: 0.5rem;">
                <button class="mode-btn active" data-mode="code" onclick="switchAIMode('code')">CODE</button>
                <button class="mode-btn" data-mode="image" onclick="switchAIMode('image')">IMAGE</button>
                <button class="mode-btn" data-mode="chat" onclick="switchAIMode('chat')">CHAT</button>
            </div>
            
            <div id="aiContent" class="ai-content"></div>
            
            <div class="ai-input-area">
                <textarea 
                    id="aiPrompt" 
                    placeholder="Enter your request..."
                    rows="3"
                ></textarea>
                <button onclick="sendAIRequest()" class="button">SEND TO GROK</button>
            </div>
        </div>
    </div>

    <!-- Footer Status Bar -->
    <div class="footer-status">
        <div class="status-left">
            <div class="status-item">
                <div class="status-dot" id="aiStatusDot"></div>
                <span id="aiStatus">AI: Disconnected</span>
            </div>
            <div class="status-item">
                <span id="folderStatus">No folder opened</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-item">
                <span id="fileCount">Files: 0</span>
            </div>
            <div class="status-item">
                <span id="openTabsCount">Open: 0</span>
            </div>
            <div class="status-item">
                <span id="modifiedCount">Modified: 0</span>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        const AppState = {
            currentDirectoryHandle: null,
            openFiles: new Map(),
            currentFile: null,
            aiMode: 'code',
            aiConnected: false,
            modifiedFiles: new Set(),
            fileStructure: null
        };

        // UI Elements
        const UI = {
            editor: document.getElementById('editor'),
            fileExplorer: document.getElementById('fileExplorer'),
            aiContent: document.getElementById('aiContent'),
            aiPrompt: document.getElementById('aiPrompt'),
            tabs: document.getElementById('tabs'),
            saveBtn: document.getElementById('saveBtn'),
            saveAllBtn: document.getElementById('saveAllBtn'),
            newFileBtn: document.getElementById('newFileBtn'),
            openFolderBtn: document.getElementById('openFolderBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            clearAIBtn: document.getElementById('clearAIBtn'),
            // Status bar elements
            aiStatus: document.getElementById('aiStatus'),
            aiStatusDot: document.getElementById('aiStatusDot'),
            folderStatus: document.getElementById('folderStatus'),
            fileCount: document.getElementById('fileCount'),
            openTabsCount: document.getElementById('openTabsCount'),
            modifiedCount: document.getElementById('modifiedCount')
        };

        // Initialize the application
        function initializeApp() {
            console.log('[SYSTEM] Initializing IDE...');
            
            // Check AI connection
            checkAIConnection();
            
            // Update status bar
            updateStatusBar();
            
            // Initialize resize handles
            initializeResizeHandles();
            
            // Set up editor change listener
            UI.editor.addEventListener('input', handleEditorChange);
            
            // Set up AI prompt enter key
            UI.aiPrompt.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendAIRequest();
                }
            });
            
            console.log('[SYSTEM] IDE initialized successfully');
        }

        // Check AI connection status
        async function checkAIConnection() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                AppState.aiConnected = data.features.aiCompletion;
                updateAIStatus();
            } catch (error) {
                console.error('[AI] Connection check failed:', error);
                AppState.aiConnected = false;
                updateAIStatus();
            }
        }

        // Update AI status in the status bar
        function updateAIStatus() {
            if (AppState.aiConnected) {
                UI.aiStatus.textContent = 'AI: Connected';
                UI.aiStatusDot.className = 'status-dot';
            } else {
                UI.aiStatus.textContent = 'AI: Disconnected';
                UI.aiStatusDot.className = 'status-dot offline';
            }
        }

        // Update the status bar with current information
        function updateStatusBar() {
            // Update folder status
            if (AppState.currentDirectoryHandle) {
                UI.folderStatus.textContent = `Folder: ${AppState.currentDirectoryHandle.name}`;
            } else {
                UI.folderStatus.textContent = 'No folder opened';
            }

            // Update file count
            const fileCount = AppState.fileStructure ? countFiles(AppState.fileStructure) : 0;
            UI.fileCount.textContent = `Files: ${fileCount}`;

            // Update open tabs count
            UI.openTabsCount.textContent = `Open: ${AppState.openFiles.size}`;

            // Update modified files count
            UI.modifiedCount.textContent = `Modified: ${AppState.modifiedFiles.size}`;
        }

        // Count total files in structure
        function countFiles(structure) {
            let count = 0;
            for (const item of structure) {
                if (item.type === 'file') {
                    count++;
                } else if (item.children) {
                    count += countFiles(item.children);
                }
            }
            return count;
        }

        // Handle editor content changes
        function handleEditorChange() {
            if (AppState.currentFile) {
                const currentContent = UI.editor.value;
                const fileData = AppState.openFiles.get(AppState.currentFile);
                
                if (fileData && currentContent !== fileData.originalContent) {
                    AppState.modifiedFiles.add(AppState.currentFile);
                    markTabAsModified(AppState.currentFile, true);
                } else {
                    AppState.modifiedFiles.delete(AppState.currentFile);
                    markTabAsModified(AppState.currentFile, false);
                }
                
                // Update file content in memory
                if (fileData) {
                    fileData.content = currentContent;
                }
                
                updateStatusBar();
            }
        }

        // Mark tab as modified
        function markTabAsModified(fileName, isModified) {
            const tab = document.querySelector(`.tab[data-filename="${fileName}"]`);
            if (tab) {
                const tabText = tab.querySelector('.tab-text') || tab.firstChild;
                if (isModified && !tabText.textContent.includes('●')) {
                    tabText.textContent = '● ' + fileName;
                } else if (!isModified && tabText.textContent.includes('●')) {
                    tabText.textContent = fileName;
                }
            }
        }

        // Open folder using File System API
        async function openFolder() {
            try {
                if (!('showDirectoryPicker' in window)) {
                    showError('File System API not supported in this browser');
                    return;
                }

                const handle = await window.showDirectoryPicker();
                AppState.currentDirectoryHandle = handle;
                
                console.log('[SYSTEM] Folder opened:', handle.name);
                
                await loadFileStructure(handle);
                
                // Enable UI elements
                UI.saveBtn.disabled = false;
                UI.saveAllBtn.disabled = false;
                UI.newFileBtn.disabled = false;
                UI.editor.disabled = false;
                UI.refreshBtn.style.opacity = '1';
                
                updateStatusBar();
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showError('Failed to open folder: ' + error.message);
                }
            }
        }

        // Load and display file structure
        async function loadFileStructure(directoryHandle) {
            try {
                UI.fileExplorer.innerHTML = '<div class="welcome-message">Loading files...</div>';
                const files = await listFiles(directoryHandle);
                AppState.fileStructure = files;
                renderFileStructure(files);
                updateStatusBar();
            } catch (error) {
                showError('Error loading file structure: ' + error.message);
            }
        }

        // Recursively list files in directory
        async function listFiles(directoryHandle) {
            const files = [];
            for await (const entry of directoryHandle.values()) {
                if (entry.kind === 'directory') {
                    files.push({
                        type: 'directory',
                        name: entry.name,
                        handle: entry,
                        children: await listFiles(entry)
                    });
                } else if (entry.kind === 'file') {
                    files.push({ 
                        type: 'file', 
                        name: entry.name,
                        handle: entry 
                    });
                }
            }
            return files.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'directory' ? -1 : 1;
            });
        }

        // Render file structure in explorer
        function renderFileStructure(files, parentElement = UI.fileExplorer, parentHandle = AppState.currentDirectoryHandle) {
            parentElement.innerHTML = '';
            
            parentElement.oncontextmenu = (e) => showContextMenu(e, parentHandle);
            
            files.forEach(item => {
                if (item.type === 'directory') {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder';
                    
                    const folderName = document.createElement('div');
                    folderName.className = 'folder-name';
                    folderName.innerHTML = `<span class="folder-icon">📁</span>${item.name}`;
                    
                    const filesDiv = document.createElement('div');
                    filesDiv.className = 'files';
                    filesDiv.style.display = 'none';
                    
                    folderName.oncontextmenu = (e) => {
                        e.stopPropagation();
                        showContextMenu(e, item.handle);
                    };
                    
                    folderName.onclick = () => {
                        filesDiv.style.display = filesDiv.style.display === 'none' ? 'block' : 'none';
                    };
                    
                    if (item.children && item.children.length > 0) {
                        renderFileStructure(item.children, filesDiv, item.handle);
                    }
                    
                    folderDiv.appendChild(folderName);
                    folderDiv.appendChild(filesDiv);
                    parentElement.appendChild(folderDiv);
                } else {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file';
                    
                    const fileIcon = getFileIcon(item.name);
                    fileDiv.innerHTML = `<span class="file-icon">${fileIcon}</span>${item.name}`;
                    fileDiv.onclick = () => openFile(item.name, item.handle);
                    parentElement.appendChild(fileDiv);
                }
            });
        }

        // Get appropriate icon for file type
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                'js': '📄',
                'ts': '📘',
                'html': '🌐',
                'css': '🎨',
                'json': '📋',
                'md': '📝',
                'txt': '📄',
                'py': '🐍',
                'java': '☕',
                'cpp': '⚙️',
                'c': '⚙️',
                'php': '🐘',
                'rb': '💎',
                'go': '🐹',
                'rs': '🦀',
                'png': '🖼️',
                'jpg': '🖼️',
                'jpeg': '🖼️',
                'gif': '🖼️',
                'svg': '🖼️'
            };
            return iconMap[ext] || '📄';
        }

        // Open file in editor
        async function openFile(fileName, fileHandle) {
            try {
                const file = await fileHandle.getFile();
                const content = await file.text();
                
                AppState.openFiles.set(fileName, { 
                    content: content, 
                    originalContent: content,
                    handle: fileHandle 
                });
                
                createOrActivateTab(fileName);
                UI.editor.value = content;
                AppState.currentFile = fileName;
                
                console.log('[FILE] Opened:', fileName);
                updateStatusBar();
                
            } catch (error) {
                showError('Error opening file: ' + error.message);
            }
        }

        // Create or activate tab for file
        function createOrActivateTab(fileName) {
            let tab = document.querySelector(`.tab[data-filename="${fileName}"]`);
            
            if (!tab) {
                tab = document.createElement('div');
                tab.className = 'tab';
                tab.setAttribute('data-filename', fileName);
                tab.innerHTML = `
                    <span class="tab-text">${fileName}</span>
                    <span class="tab-close" onclick="closeTab('${fileName}', event)">×</span>
                `;
                tab.onclick = (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        activateTab(fileName);
                    }
                };
                UI.tabs.appendChild(tab);
            }
            
            activateTab(fileName);
        }

        // Activate specific tab
        function activateTab(fileName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tab = document.querySelector(`.tab[data-filename="${fileName}"]`);
            if (tab) {
                tab.classList.add('active');
                const fileData = AppState.openFiles.get(fileName);
                if (fileData) {
                    UI.editor.value = fileData.content;
                    AppState.currentFile = fileName;
                }
            }
        }

        // Close tab
        function closeTab(fileName, event) {
            if (event) event.stopPropagation();
            
            const tab = document.querySelector(`.tab[data-filename="${fileName}"]`);
            if (tab) {
                if (tab.classList.contains('active')) {
                    const nextTab = tab.nextElementSibling || tab.previousElementSibling;
                    if (nextTab) {
                        activateTab(nextTab.getAttribute('data-filename'));
                    } else {
                        UI.editor.value = '';
                        AppState.currentFile = null;
                    }
                }
                tab.remove();
                AppState.openFiles.delete(fileName);
                AppState.modifiedFiles.delete(fileName);
                updateStatusBar();
            }
        }

        // Save current file
        async function saveCurrentFile() {
            if (!AppState.currentFile) {
                showError('No file is currently open');
                return;
            }
            
            try {
                const fileData = AppState.openFiles.get(AppState.currentFile);
                if (!fileData || !fileData.handle) {
                    throw new Error('File handle not found');
                }
                
                const content = UI.editor.value;
                const writable = await fileData.handle.createWritable();
                await writable.write(content);
                await writable.close();
                
                // Update stored content
                fileData.originalContent = content;
                fileData.content = content;
                AppState.modifiedFiles.delete(AppState.currentFile);
                markTabAsModified(AppState.currentFile, false);
                
                console.log('[FILE] Saved:', AppState.currentFile);
                updateStatusBar();
                showSuccess(`File ${AppState.currentFile} saved successfully`);
                
            } catch (error) {
                showError('Error saving file: ' + error.message);
            }
        }

        // Save all modified files
        async function saveAllFiles() {
            if (AppState.modifiedFiles.size === 0) {
                showError('No modified files to save');
                return;
            }

            let savedCount = 0;
            const totalFiles = AppState.modifiedFiles.size;

            for (const fileName of AppState.modifiedFiles) {
                try {
                    const fileData = AppState.openFiles.get(fileName);
                    if (fileData && fileData.handle) {
                        const writable = await fileData.handle.createWritable();
                        await writable.write(fileData.content);
                        await writable.close();
                        
                        fileData.originalContent = fileData.content;
                        markTabAsModified(fileName, false);
                        savedCount++;
                    }
                } catch (error) {
                    console.error(`[FILE] Error saving ${fileName}:`, error);
                }
            }

            AppState.modifiedFiles.clear();
            updateStatusBar();
            showSuccess(`Saved ${savedCount}/${totalFiles} files successfully`);
        }

        // Create new file in root directory
        async function createNewFileInRoot() {
            if (!AppState.currentDirectoryHandle) {
                showError('No project folder open');
                return;
            }

            const fileName = prompt('Enter file name:');
            if (!fileName) return;

            try {
                const fileHandle = await AppState.currentDirectoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write('');
                await writable.close();
                
                await refreshFileExplorer();
                console.log('[FILE] Created:', fileName);
                
            } catch (error) {
                showError('Error creating file: ' + error.message);
            }
        }

        // Refresh file explorer
        async function refreshFileExplorer() {
            if (AppState.currentDirectoryHandle) {
                await loadFileStructure(AppState.currentDirectoryHandle);
            }
        }

        // Context menu functionality
        let contextMenu = null;
        let currentContextDirectory = null;

        function showContextMenu(e, directoryHandle) {
            e.preventDefault();
            removeContextMenu();
            
            currentContextDirectory = directoryHandle;
            
            contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.innerHTML = `
                <div class="context-menu-item" onclick="createNewFile()">
                    <span>📄</span> New File
                </div>
                <div class="context-menu-item" onclick="createNewFolder()">
                    <span>📁</span> New Folder
                </div>
            `;
            
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            
            document.body.appendChild(contextMenu);
            
            setTimeout(() => {
                document.addEventListener('click', removeContextMenu);
            }, 0);
        }

        function removeContextMenu() {
            if (contextMenu) {
                contextMenu.remove();
                contextMenu = null;
            }
            document.removeEventListener('click', removeContextMenu);
        }

        async function createNewFile() {
            removeContextMenu();
            const fileName = prompt('Enter file name:');
            if (!fileName) return;

            try {
                const fileHandle = await currentContextDirectory.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write('');
                await writable.close();
                
                await refreshFileExplorer();
                
            } catch (error) {
                showError('Error creating file: ' + error.message);
            }
        }

        async function createNewFolder() {
            removeContextMenu();
            const folderName = prompt('Enter folder name:');
            if (!folderName) return;

            try {
                await currentContextDirectory.getDirectoryHandle(folderName, { create: true });
                await refreshFileExplorer();
                
            } catch (error) {
                showError('Error creating folder: ' + error.message);
            }
        }

        // AI functionality
        let currentAIMode = 'code';

        function switchAIMode(mode) {
            currentAIMode = mode;
            AppState.aiMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Update placeholder text
            const placeholders = {
                code: 'Ask about code, request improvements, or generate new code...',
                image: 'Describe an image you want to generate...',
                chat: 'Ask any question or start a conversation...'
            };
            UI.aiPrompt.placeholder = placeholders[mode];
        }

        async function sendAIRequest() {
            const prompt = UI.aiPrompt.value.trim();
            if (!prompt) return;

            if (!AppState.aiConnected) {
                showError('AI service is not connected');
                return;
            }

            const sendButton = document.querySelector('.ai-input-area button');
            const originalText = sendButton.textContent;
            
            try {
                sendButton.disabled = true;
                sendButton.innerHTML = '<span class="loading-spinner"></span> PROCESSING...';
                UI.aiStatusDot.className = 'status-dot processing';
                UI.aiStatus.textContent = 'AI: Processing...';

                if (currentAIMode === 'image') {
                    await generateImage(prompt);
                } else {
                    await sendChatRequest(prompt);
                }

                UI.aiPrompt.value = '';
                
            } catch (error) {
                showError('AI request failed: ' + error.message);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = originalText;
                updateAIStatus();
            }
        }

        async function sendChatRequest(prompt) {
            const messages = [
                {
                    role: "system",
                    content: `You are Grok, an AI assistant integrated into a code editor. Current mode: ${currentAIMode}. 
                    When providing code examples, always wrap them in markdown code blocks with the appropriate language identifier.
                    Be helpful, concise, and provide actionable advice.`
                }
            ];

            // Include current file content if in code mode and a file is open
            if (currentAIMode === 'code' && AppState.currentFile) {
                const fileContent = UI.editor.value;
                messages.push({
                    role: "user",
                    content: `Current file: ${AppState.currentFile}\n\nFile content:\n\`\`\`\n${fileContent}\n\`\`\`\n\nUser request: ${prompt}`
                });
            } else {
                messages.push({
                    role: "user",
                    content: prompt
                });
            }

            const response = await fetch('/api/completion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages })
            });

            if (!response.ok) {
                throw new Error('Failed to get AI response');
            }

            const data = await response.json();
            displayAIResponse(prompt, data.choices[0].message.content);
        }

        async function generateImage(prompt) {
            const response = await fetch('/api/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: prompt,
                    response_format: "url"
                })
            });

            if (!response.ok) {
                throw new Error('Failed to generate image');
            }

            const data = await response.json();
            displayImageResponse(prompt, data.imageUrl);
        }

        function displayAIResponse(prompt, response) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.innerHTML = `
                <div><strong>Q:</strong> ${escapeHtml(prompt)}</div>
                <div><strong>A:</strong> ${formatMarkdown(response)}</div>
                <hr style="border: none; border-top: 1px solid #333333; margin: 1rem 0;">
            `;
            
            UI.aiContent.appendChild(messageDiv);
            UI.aiContent.scrollTop = UI.aiContent.scrollHeight;
        }

        function displayImageResponse(prompt, imageUrl) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.innerHTML = `
                <div><strong>Generated Image:</strong> ${escapeHtml(prompt)}</div>
                <img src="${imageUrl}" alt="Generated image" class="image-preview" />
                <div style="margin-top: 0.5rem;">
                    <button class="code-action-btn" onclick="saveImageToProject('${imageUrl}', '${prompt}')">Save to Project</button>
                </div>
                <hr style="border: none; border-top: 1px solid #333333; margin: 1rem 0;">
            `;
            
            UI.aiContent.appendChild(messageDiv);
            UI.aiContent.scrollTop = UI.aiContent.scrollHeight;
        }

        async function saveImageToProject(imageUrl, prompt) {
            if (!AppState.currentDirectoryHandle) {
                showError('No project folder open');
                return;
            }

            try {
                // Generate filename from prompt
                const fileName = prompt.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 30) + '_generated.png';

                // Fetch the image
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                
                // Save to project folder
                const fileHandle = await AppState.currentDirectoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                await refreshFileExplorer();
                showSuccess(`Image saved as ${fileName}`);
                
            } catch (error) {
                showError('Error saving image: ' + error.message);
            }
        }

        function formatMarkdown(text) {
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            
            return text.replace(codeBlockRegex, (match, language, code) => {
                const langClass = language ? ` class="language-${language}"` : '';
                return `<pre><div class="code-actions">
                    <button class="code-action-btn" onclick="copyCode(this)">Copy</button>
                    <button class="code-action-btn" onclick="insertCode(this)">Insert</button>
                    <button class="code-action-btn" onclick="createFileFromCode(this, '${language || 'txt'}')">Create File</button>
                </div><code${langClass}>${escapeHtml(code.trim())}</code></pre>`;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyCode(button) {
            const codeElement = button.closest('pre').querySelector('code');
            navigator.clipboard.writeText(codeElement.textContent)
                .then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 1500);
                })
                .catch(err => showError('Failed to copy code: ' + err.message));
        }

        function insertCode(button) {
            const codeElement = button.closest('pre').querySelector('code');
            const cursorPos = UI.editor.selectionStart;
            const textBefore = UI.editor.value.substring(0, cursorPos);
            const textAfter = UI.editor.value.substring(cursorPos);
            
            UI.editor.value = textBefore + codeElement.textContent + textAfter;
            UI.editor.focus();
            
            // Update the stored content for the current file
            if (AppState.currentFile) {
                const fileData = AppState.openFiles.get(AppState.currentFile);
                if (fileData) {
                    fileData.content = UI.editor.value;
                    AppState.modifiedFiles.add(AppState.currentFile);
                    markTabAsModified(AppState.currentFile, true);
                    updateStatusBar();
                }
            }
        }

        async function createFileFromCode(button, language) {
            if (!AppState.currentDirectoryHandle) {
                showError('No project folder open');
                return;
            }

            const codeElement = button.closest('pre').querySelector('code');
            const code = codeElement.textContent;
            
            const extensions = {
                'javascript': 'js',
                'typescript': 'ts',
                'python': 'py',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'markdown': 'md',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'php': 'php',
                'ruby': 'rb',
                'go': 'go',
                'rust': 'rs'
            };

            const ext = extensions[language] || 'txt';
            const fileName = prompt(`Enter filename (will be saved as .${ext}):`, `new_file.${ext}`);
            
            if (!fileName) return;

            try {
                const fileHandle = await AppState.currentDirectoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(code);
                await writable.close();
                
                await refreshFileExplorer();
                showSuccess(`File ${fileName} created successfully`);
                
            } catch (error) {
                showError('Error creating file: ' + error.message);
            }
        }

        function clearAIChat() {
            UI.aiContent.innerHTML = '';
        }

        // Resize handles functionality
        function initializeResizeHandles() {
            const leftHandle = document.getElementById('leftResizeHandle');
            const rightHandle = document.getElementById('rightResizeHandle');
            const sidebar = document.querySelector('.sidebar');
            const aiColumn = document.querySelector('.ai-column');

            function initializeResize(handle, element, isLeft) {
                let startX, startWidth;

                function startResize(e) {
                    startX = e.clientX;
                    startWidth = parseInt(getComputedStyle(element).width, 10);
                    handle.classList.add('active');
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                    document.body.style.userSelect = 'none';
                }

                function resize(e) {
                    const diff = e.clientX - startX;
                    let newWidth = isLeft ? startWidth + diff : startWidth - diff;
                    
                    newWidth = Math.max(200, Math.min(600, newWidth));
                    element.style.width = `${newWidth}px`;
                }

                function stopResize() {
                    handle.classList.remove('active');
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                    document.body.style.userSelect = '';
                }

                handle.addEventListener('mousedown', startResize);
            }

            initializeResize(leftHandle, sidebar, true);
            initializeResize(rightHandle, aiColumn, false);
        }

        // Utility functions
        function showError(message) {
            console.error('[ERROR]', message);
            alert('ERROR: ' + message);
        }

        function showSuccess(message) {
            console.log('[SUCCESS]', message);
            // You could implement a toast notification here
            alert('SUCCESS: ' + message);
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>